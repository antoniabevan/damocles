MODULE class_dust

    USE globals

    implicit none

    TYPE species_obj                        !each species has the following attributes
        INTEGER ::  id                          !id number
        INTEGER ::  nsizes                      !number of grain sizes
        INTEGER ::  nwav                        !number of wavelengths
        REAL    ::  interval                    !spacing of grain sizes
        REAL    ::  amin,amax                   !amin, amax
        REAL    ::  weight                      !relative weight of species (fractional weighting by area)
        REAL    ::  mweight                     !relative weight of species (fractional weighting by mass)
        REAL    ::  vweight                     !relative weight of species (fraction weighting by volume)
        REAL    ::  power                       !exponent for power law size distribution
        REAL    ::  rhograin                    !density of a dust grain

        CHARACTER(LEN=50)   ::  dataFile        !data file containing optical constants for species
        REAL,ALLOCATABLE    ::  gsize(:,:)      !array containing grain sizes (1) and weights (2)
        REAL,ALLOCATABLE    ::  sca_opacity(:)  !array containing scattering extinctions at each wavelength
        REAL,ALLOCATABLE    ::  ext_opacity(:)  !array containing extinctions at each wavelength
        REAL,ALLOCATABLE    ::  g(:)            !array containing g (asymmetry factor) at each wavelength
        REAL,ALLOCATABLE    ::  wav(:)          !array containing the wavelengths
        REAL,ALLOCATABLE    ::  albedo(:)       !array containing albedos for each wavelength
    END TYPE species_obj

    TYPE dust_obj
        INTEGER                       ::  n_species           !number of species
        REAL                          ::  total_weight        !!to check that total weights of species add to 1
        REAL                          ::  mass                !total mass of dust (M_sun)
        REAL                          ::  mass_grams          !total mass of dust (grams)
        TYPE(species_obj),ALLOCATABLE ::  species(:)
    END TYPE dust_obj

    TYPE(dust_obj) :: dust

contains

    SUBROUTINE calculate_sizes()

        REAL    ::  norm  !normalising scale factor

        !read species file in
        OPEN(21,file = species_file)

        READ(21,*) dust%n_species
        READ(21,*)
        READ(21,*)
        READ(21,*)

        WRITE(55,*) 'number of species',dust%n_species
        !ALLOCATE(dust%species(dust%n_species))
        ALLOCATE(dust%species(2))
        dust%total_weight=0.



        DO ii=1,dust%n_species
            READ(21,*) dust%species(ii)%id,dust%species(ii)%dataFile,dust%species(ii)%weight,dust%species(ii)%amin,dust%species(ii)%amax,dust%species(ii)%power,dust%species(ii)%nsizes
            ALLOCATE(dust%species(ii)%gsize(dust%species(ii)%nsizes,2))
            dust%species(ii)%gsize=0
            dust%species(ii)%dataFile=trim(dust%species(ii)%dataFile)
            dust%total_weight=dust%total_weight+dust%species(ii)%weight
            !CHANGE HERE FOR MORE THAN 1 SPECIES

        END DO

        IF (dust%total_weight/=1) THEN
            PRINT*, 'WARNING - total species weights do not add to 1'
            PRINT*, 'total weights =',dust%total_weight
        END IF

        CLOSE(21)


        !calculate grain sizes and relative weights
        DO ii=1,dust%n_species
            dust%species(ii)%interval=(dust%species(ii)%amax-dust%species(ii)%amin)/real(dust%species(ii)%nsizes)
            norm=0
            PRINT*,'area weight',dust%species(ii)%weight
            dust%species(ii)%vweight=(1.0/(1.0+(1.0/dust%species(ii)%weight-1)**(1.5)))
            PRINT*,'volume weight',dust%species(ii)%vweight
            DO jj=1,dust%species(ii)%nsizes
                dust%species(ii)%gsize(jj,1)=dust%species(ii)%amin+((jj-1)*dust%species(ii)%interval)
                !PRINT*,j-1,dust%species(i)%gsize(j,1)
                norm=norm+(dust%species(ii)%gsize(jj,1)**dust%species(ii)%power)
            END DO
            !normalise weights using SF
            DO jj=1,dust%species(ii)%nsizes
                dust%species(ii)%gsize(jj,2)=(dust%species(ii)%gsize(jj,1)**dust%species(ii)%power)/norm
                !PRINT*,i,j,dust%species(i)%gsize(j,1),dust%species(i)%gsize(j,2)
            END DO
        END DO


    END SUBROUTINE calculate_sizes

END MODULE class_dust
