module model_comparison

    use globals
    use class_line
    use class_geometry
    use class_dust
    use class_grid
    use class_freq_grid

    implicit none

    type obs_profile
        integer             :: n_data
        real,allocatable    :: vel(:)
        real,allocatable    :: flux(:)
        logical,allocatable :: exclude(:)
    end type

    type(obs_profile) obs_data,model_rebinned

    integer              :: bin_id_low,bin_id_high
    real                 :: scale_factor, sf
    real                 :: chi_sq_new
    real,parameter       :: error=1
    integer              :: no_exclusion_zones
    real,allocatable     :: exclusion_zone(:,:)

contains

    subroutine read_in_data()

        open(55,file=data_file)
        read(55,*) obs_data%n_data

        allocate(obs_data%vel(obs_data%n_data))
        allocate(obs_data%flux(obs_data%n_data))

        do ii = 1,obs_data%n_data
            read(55,*) obs_data%vel(ii),obs_data%flux(ii)
        end do

        open(56,file=data_exclusions_file)
        read(56,*) no_exclusion_zones
        allocate(exclusion_zone(no_exclusion_zones,2))

        do ii = 1,no_exclusion_zones*2
            read(56,*) exclusion_zone(ii,1),exclusion_zone(ii,2)
            if (exclusion_zone(ii,1)>exclusion_zone(ii,2)) print*,'warning: please re-order your exclusion zone limits to be in ascending order and re-run.'
        end do

    end subroutine

    subroutine calculate_likelihood()

        !allocate space for new modelled line profile binned to same velocity bins as observed data
        allocate(model_rebinned%vel(obs_data%n_data))
        allocate(model_rebinned%flux(obs_data%n_data))
        allocate(model_rebinned_exclude(obs_data%n_data))

        !set model velocity bins to be the same as those of observed line profile
        model_rebinned%vel = obs_data%vel

        !interpolate between nearest modelled velocity bins to find new flux in observed data velocity bins
        do ii = 1,obs_data%n_data
            bin_id_high=minloc(nu_grid%vel_bin(:)-model_rebinned%vel(ii),1,(nu_grid%vel_bin(:)-model_rebinned%vel(ii)>0))
            bin_id_low=maxloc(nu_grid%vel_bin(:)-model_rebinned%vel(ii),1,(nu_grid%vel_bin(:)-model_rebinned%vel(ii)<0))
            model_rebinned%flux(ii) = line%initial_energy*(profile_array(bin_id_low)+((profile_array(bin_id_high)-profile_array(bin_id_low))*((model_rebinned%vel(ii)-nu_grid%vel_bin(bin_id_low))/(nu_grid%vel_bin(bin_id_high)-nu_grid%vel_bin(bin_id_low)))))
        end do

        !scale modelled fluxes to data flux using peak observed line flux
        scale_factor=line%peak_flux/(sum(model_rebinned%flux(maxloc(model_rebinned%flux,1)-5:maxloc(model_rebinned%flux,1)+5))/size(model_rebinned%flux(maxloc(model_rebinned%flux,1)-5:maxloc(model_rebinned%flux,1)+5)))

        do ii = 1,obs_data%n_data
            do jj = 1,no_exclusion_zones
                if ((model_rebinned%vel>exclusion_zone(jj,1)) .and. (model_rebinned%vel<exclusion_zone(jj,2))) then
                    model_rebinned_exclude(ii) = .true.

        !calculate chi_sq
        do ii = 1,obs_data%n_data
            do jj = 1,no_exclusion_zones
                if model_rebinned%vel<exclusion_zone(jj,2)
            chi_sq = chi_sq+((model_rebinned%flux(ii)*scale_factor-obs_data%flux(ii))/error)**2
        end do

        !optimise scale factor to give best fit by trying a range of scale factors between 0.6 and 1.5 the initial factor above
        do jj =1,10
            sf = scale_factor*(0.5+0.1*jj)
            print*,jj,sf
            do ii = 1,obs_data%n_data
                chi_sq_new = chi_sq_new+((model_rebinned%flux(ii)*sf-obs_data%flux(ii))/error)**2
            end do
            print*,chi_sq_new
            if (chi_sq_new<chi_sq) then
                scale_factor=sf
                chi_sq=chi_sq_new
            end if
        end do
        model_rebinned%flux=model_rebinned%flux*scale_factor

        open(57,file='line.out')
        do ii = 1,obs_data%n_data
            write(57,*) model_rebinned%vel(ii),model_rebinned%flux(ii)
        end do

    end subroutine


end module model_comparison
