module model_comparison

    use globals
    use class_line
    use class_geometry
    use class_dust
    use class_grid
    use class_freq_grid

    implicit none

    type obs_profile
        integer          :: n_data
        real,allocatable :: vel(:)
        real,allocatable :: flux(:)
    end type

    type(obs_profile) obs_data,model_rebinned

    integer              :: bin_id_low,bin_id_high

contains

    subroutine read_in_data()

        open(55,file=data_file)
        read(55,*) obs_data%n_data

        allocate(obs_data%vel(obs_data%n_data))
        allocate(obs_data%flux(obs_data%n_data))

        do ii = 1,obs_data%n_data
            read(55,*) obs_data%vel(ii),obs_data%flux(ii)
        end do

    end subroutine

    subroutine calculate_likelihood()



        !allocate space for new modelled line profile binned to same velocity bins as observed data
        allocate(model_rebinned%vel(obs_data%n_data))
        allocate(model_rebinned%flux(obs_data%n_data))

        !set model velocity bins to be the same as those of observed line profile
        model_rebinned%vel = obs_data%vel

        !interpolate between nearest modelled velocity bins to find new flux in observed data velocity bins
        do ii = 1,obs_data%n_data
            bin_id_high=minloc(nu_grid%vel_bin(:)-model_rebinned%vel(ii),1,(nu_grid%vel_bin(:)-model_rebinned%vel(ii)>0))
            bin_id_low=maxloc(nu_grid%vel_bin(:)-model_rebinned%vel(ii),1,(nu_grid%vel_bin(:)-model_rebinned%vel(ii)<0))
            model_rebinned%flux(ii) = line%initial_energy*(profile_array(bin_id_low)+((profile_array(bin_id_high)-profile_array(bin_id_low))*((model_rebinned%vel(ii)-nu_grid%vel_bin(bin_id_low))/(nu_grid%vel_bin(bin_id_high)-nu_grid%vel_bin(bin_id_low)))))
        end do

        !scale modelled fluxes to data flux using peak observed line flux

        model_rebinned%flux=model_rebinned%flux*line%peak_flux/(sum(model_rebinned%flux(maxloc(model_rebinned%flux)-5:maxloc(model_rebinned%flux,1)+5))/size(model_rebinned%flux(maxloc(model_rebinned%flux,1)-5:maxloc(model_rebinned%flux,1)+5)))

        open(57,file='line.out')

        do ii = 1,obs_data%n_data
            write(57,*) model_rebinned%vel(ii),model_rebinned%flux(ii)
        end do


    end subroutine


end module model_comparison
