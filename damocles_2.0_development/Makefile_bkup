FC=gfortran
LD=gfortran
FFLAGS += -cpp -fbounds-check -ffree-line-length-0 -fopenmp -Jsource/ -DPREFIX=\"${PREFIX}\"
PREFIX=/usr

ifeq ($(CO),debug)
  FFLAGS += -g -pg -fbounds-check -Wall -Wuninitialized -ffpe-trap=zero,overflow,invalid,underflow,denormal
else
  FFLAGS += -O3
endif

.PHONY: all clean new install

all:	damocles

new:    clean all

source/%.o: source/%.f90
	$(FC) $(FFLAGS) $^ -c -o $@

damocles: source/input.o source/electron_scattering.o source/random_routines.o source/vector_functions.o source/grain_sizes.o source/initialise.o source/init_packet.o source/BHmie.o source/init_random_seed.o \
source/propagate.o source/construct_grid.o source/model_comparison.o source/driver.o source/damocles_wrap.o source/damocles.o
	$(LD) $(LDFLAGS) $(FFLAGS) -o $@ $^

clean:
	rm -f damocles source/*.o source/*.mod

install: damocles
	test -e ${DESTDIR}${PREFIX}/share/damocles || mkdir -p ${DESTDIR}${PREFIX}/share/damocles
	test -e ${DESTDIR}${PREFIX}/bin || mkdir -p ${DESTDIR}${PREFIX}/bin
	cp -r dustData/ ${DESTDIR}${PREFIX}/share/damocles
	install damocles ${DESTDIR}${PREFIX}/bin

uninstall:
	rm -f ${DESTDIR}${PREFIX}/bin/damocles
	rm -rf ${DESTDIR}${PREFIX}/share/damocles
